<!-- Generated by Ruler -->


<!-- Source: AGENTS.md -->

# AGENTS.md Agent Instructions for codex-hookify-mcp

Centralised AI agent instructions. Add coding guidelines, style guides, and project context here.

Ruler concatenates all .md files in this directory (and subdirectories), starting with AGENTS.md (if present), then remaining files in sorted order.

This document provides instructions for AI agents working on the `codex-hookify-mcp` project. It synthesizes information from the PRD, technical specifications, and task breakdown to ensure all development work aligns with the project's goals and architecture.

## 1. Core Project Mandate

Your primary objective is to build an MCP (Model Context Protocol) server that brings the functionality of Claude Code's `hookify` safety plugin to the `codex-cli` ecosystem.

**Core mission:**
- Implement a safety hook system for `codex-cli` that can warn or block dangerous shell commands.
- Ensure high-fidelity behavioral parity with the original Claude Code `hookify` plugin for `bash` events.
- Expose this functionality through a clear, well-defined set of MCP tools.

## 2. Guiding Principles

- **Parity First:** When in doubt, mirror the behavior and rule format of the original `hookify` plugin.
- **Safety is Paramount:** The `block > warn > allow` decision hierarchy is non-negotiable. The system must fail securely.
- **Structured Tooling:** All MCP tools must have clear, `Zod`-validated input schemas. Do not implement natural language parsing within the server; let the client (Codex) handle that.
- **Stateless Engine:** The core rule evaluation engine should be a pure function that takes rules and a context object, and returns a decision.
- **Atomic Operations:** All filesystem writes, especially rule updates, must be atomic (e.g., write to a temporary file, then rename) to prevent data corruption.

## 3. Technical Stack & Key Libraries

- **Language:** TypeScript (strict mode enabled)
- **Runtime:** Node.js
- **MCP Framework:** `@modelcontextprotocol/sdk`
- **Schema Validation:** `zod`
- **Rule Parsing:** `gray-matter` for parsing Markdown with YAML frontmatter.
- **Build System:** `tsc` (TypeScript Compiler)

## 4. Architectural Overview

The system consists of four main layers:

1.  **Foundation Layer:** Defines core data structures (`Rule`, `Condition`, etc.) and handles configuration loading (e.g., `HOOKIFY_RULE_DIR`).
2.  **Rule Store & Parsing Layer:** Responsible for reading `.md` rule files from the filesystem, parsing them with `gray-matter`, validating their structure, and serializing them back to disk.
3.  **Evaluation Engine Layer:** Contains the core logic for matching rules against events. This includes the `conditionMatcher` and the `shellEvaluator`.
4.  **MCP Tools Layer:** Exposes the engine's functionality and rule management capabilities to the `codex-cli` via a stdio-based MCP server.

## 5. Key File Locations & Module Responsibilities

-   **`src/types/rule.ts`**: Defines the core `Rule`, `Condition`, `EventType`, and `ActionType` interfaces. This is the single source of truth for the data model.
-   **`src/config/env.ts`**: Exports `getConfig()` to resolve the rule directory, defaulting to `~/.codex/hookify`.
-   **`src/rules/ruleParser.ts`**: Parses a Markdown file's content into a raw `Rule` object using `gray-matter`.
-   **`src/rules/ruleValidator.ts`**: Validates a raw rule, applies defaults, and pre-compiles regex patterns.
-   **`src/rules/ruleStore.ts`**: Manages filesystem operations: `loadRules`, `writeRule`, and `updateRuleEnabled`.
-   **`src/engine/conditionMatcher.ts`**: Evaluates a rule's `conditions` array against a context object. Supports operators: `regex_match`, `contains`, `not_contains`, `equals`.
-   **`src/engine/shellEvaluator.ts`**: The main evaluation entrypoint. Filters rules, applies pattern/condition matching for `bash` events, and aggregates decisions.
-   **`src/mcp/server.ts`**: The main entrypoint for the MCP server. It initializes the `McpServer`, registers all tools, and connects the `StdioServerTransport`.
-   **`src/mcp/tools/*.ts`**: Each file in this directory implements a specific MCP tool (`hookify_evaluate_shell`, `hookify_list_rules`, etc.).

## 6. Development Workflow & Task Dependencies

Follow the development phases outlined in the PRD. The tasks are structured to build the system from the ground up, ensuring dependencies are met at each stage.

1.  **Phase 0 (Foundation):** Implement `src/types/rule.ts` and `src/config/env.ts`.
2.  **Phase 1 (Rule Store):** Build the rule parser, validator, and filesystem store.
3.  **Phase 2 (Engine):** Implement the condition matcher and shell evaluator.
4.  **Phase 3 (MCP Server):** Create the server skeleton and implement all `hookify_*` MCP tools. This completes the core MVP.
5.  **Phase 4 (Integration):** Generate documentation and integration snippets for `codex-cli`.

Refer to `.taskmaster/tasks/tasks.json` for the detailed breakdown of tasks and subtasks. Adhere strictly to the defined dependencies.

## 7. Instructions for Using MCP Tools

When acting as the `codex-cli` agent, you must adhere to the following logic:

-   **Evaluation:** Before executing **any** shell command that could modify the filesystem or system state, you **must** first call the `hookify_evaluate_shell` tool with the exact command you intend to run.
-   **Handling Decisions:**
    -   If the tool returns `{"decision": "block"}`, you **must not** run the command. Inform the user of the block and display the messages provided.
    -   If the tool returns `{"decision": "warn"}`, you **must** show the user the warning messages and **ask for explicit confirmation** before proceeding with the command.
    -   If the tool returns `{"decision": "allow"}`, you may proceed with the command.
-   **Rule Management:**
    -   Use `hookify_create_rule` to create new safety rules based on user requests. Ensure you provide all required structured arguments.
    -   Use `hookify_list_rules` to inspect the currently active rules.
    -   Use `hookify_set_rule_enabled` to toggle rules on or off as requested by the user.

By following these instructions, you will ensure the safe, consistent, and effective operation of the `codex-hookify-mcp` server within the `codex-cli` environment.



<!-- Source: .ruler/AGENTS.md -->

# AGENTS.md

Centralised AI agent instructions. Add coding guidelines, style guides, and project context here.

Ruler concatenates all .md files in this directory (and subdirectories), starting with AGENTS.md (if present), then remaining files in sorted order.
